import os
import re
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# Ваш основний код бота...
# Налаштування
BOT_TOKEN = os.getenv("BOT_TOKEN")
BOT_USERNAME = "@IvanRozumnykBot"

QA_PAIRS = {
    # ============ Пости та спойлери ============
    r"\b(де|коли|чи буде|скільки|чекаю|хочу|коли очікувати|коли покажуть).*(пост|спойлер|новий|наступний|контент|інформація|матеріали|допис|щось нове)|(викладуть|з'явиться|буде).*(пост|спойлер)\b":
    "Спойлер з'явиться лише після досягнення необхідної кількості реакцій. Після цього може знадобитися додатковий час для підготовки матеріалу.",
    r"\b(чому).*(довго|довго чекати|мало|рідко|немає|повільно).*(спойлер|пост|інформація|оновлення)\b":
    "Розробники працюють над якісним контентом. Частота публікацій залежить від активності спільноти (реакцій) та наявності нових матеріалів.",
    r"\b(як пришвидшити|що робити щоб швидше|як допомогти|що впливає).*(спойлер|пост|контент)\b":
    "Ставте реакції (лайки, репости) під постами - це головний фактор для прискорення виходу нових матеріалів.",
    r"\b(чи буде|чи вийде).*(сьогодні|зараз).*(спойлер|пост|публікація)\b":
    "Якщо необхідна кількість реакцій була досягнута - можливий вихід спойлера. Слідкуйте за каналом.",

    # ============ Реліз та завантаження ============
    r"\b(коли|дата|термін|чи скоро).*(реліз|вийде|буде|гра|випустять|запустять|з'явиться|очікувати|випуск|вихід|вихода коли)\b":
    "Точна дата релізу поки невідома. Гра знаходиться в активній розробці.",
    r"\b(де|як|чи можна|звідки).*(скачати|завантажити|взяти|знайти|купити|придбати|отримати|дістати|встановити|інсталювати|гру|game|download|install|скинути|поставити)\b":
    "Гра ще в розробці. Дата релізу - невідома. У майбутньому її можна буде завантажити з офіційного форуму. Інформації про Google Play або App Store поки що немає.",
    r"\b(чи буде|яка|скільки|чи можна).*(безкоштовно|платною|ціна|коштуватиме|демо|тестовий період|безкоштовна версія)\b":
    "Гра буде безкоштовна.",
    r"\b(чи буде|чи можна).*(мультиплеєр|кооператив|пвп|грати з друзями|онлайн|одиночна гра|сюжетний режим|сюжет|кампанія)\b":
    "Так, гра буде онлайн.",

    # ============ Розробка ============
    r"\b(як йде|який|що вже|на якому|скільки|яка|чи багато).*(розробка|прогрес|зроблено|стан|етапі|залишилось|готовність|відсоток)\b":
    "Офіційної інформації про точний прогрес немає. Розробники працюють над якісним продуктом.",
    r"\b(чому).*(довго|затримка|не випускають|немає гри|стільки часу|стільки розробки|так довго розробляють)\b":
    "Розробники хочуть випустити якісний продукт і не поспішають з непідготовленим релізом.",
    r"\b(чи).*(баги|проблеми|труднощі|йде за планом|відстаєте|встигаєте)\b":
    "Про технічні деталі розробки інформація не розголошується.",
    r"\b(коли|чи|чи буде|хочу|де|скільки|коли вийде|коли буде|коли додадуть|коли з'явиться|коли випустять)\b.*\b(айфон|айфоні|айфона|айфону|айпада|айпаді|айпаду|айпод|айподу|айос|ios|іос|іпад|apple tv|apple watch|ейпл тіві|ейпл вотч|watchos)\b":
    "На iPhone/iPad/iOS вийде після виходу на Android.",
    # ============ Команда ============
    r"\b(хто|чи).*(розробляє|в команді|автор|засновник|робить гру|проєктом|велика команда|людей працює|художник|програміст|дизайнер)\b":
    "Інформація про команду буде опублікована на офіційних ресурсах.",
    r"\b(як|чи).*(долучитись|потрібні люди|вакансії|частиною команди|допомогти|взяти участь|розробників|волонтери|співпрацювати)\b":
    "Пізніше буде оголошено набір у команду. Слідкуйте за офіційними джерелами.",
    r"\b(як|де).*(зв'язатись|написати|звернутись|контакти|зв'язок|підтримку|запропонувати ідею|відправити пропозицію)\b":
    "Для пропозицій використовуйте офіційний телеграм чат: [https://t.me/+lUsMSXSadI03Nzhi] або Discord [https://discord.com/channels/1215656113056251954/1215864748411719760]",
    r"\b(дайте|скиньте|надішліть|де|як|хочу|потрібен|потрібні|знайти|знайду|шукаю|електронка|пошта|телеграм|тг|дискорд|контакт|звʼязок|зв'язок|звязок|написати|напишіть)\b.*\b(розробник[а-яі]*|дев[а-яі]*|програміст[а-яі]*|автор[а-яі]*|творц[а-яі]*)\b":
    "Контактні дані розробників не публікуються з причин конфіденційності. Усі офіційні звернення здійснюються через офіційні ресурси..",
    # ===== Адмінка =====
    r"\b(хочу|як|дайте|коли|чи|де|взяти|набір|відбір|заявка|кастинг|податись|потрапити|стать|зайти|увійти|модер[а-яі]*|адмін[а-яі]*)\b.*\b(модер[а-яі]*|адмін[а-яі]*|команду|роль|права|статус)\b":
    "Перед відкриттям буде оголошено відбір в адміністрацію. Тоді ви зможете подати заявку через офіційну форму.",
    # ============ Ігровий процес ============
    r"\b(який|як|що|чи буде).*(геймплей|грати|механіки|можливості|функції|особливості|прокачка|інвентар|крафтинг|економіка)\b":
    "Деталі ігрового процесу розкриті в публікаціях.",
    r"\b(який|яка|чи буде).*(сетинг|всесвіт|атмосфера|стиль|графіка|візуал|відкритий світ|дослідження|локацій)\b":
    "Більше інформації про ігровий світ з'явиться в наступних спойлерах.",

    # ============ Технічні питання ============
    r"\b(які|чи|чи буде).*(системні вимоги|піде на мій|телефон|андроїд|ios|консолях|ps||підтримка геймпадів)\b":
    "Технічні вимоги будуть опубліковані ближче до релізу.",
    r"\b(чи буде|які|чи є).*(руська|українська|англійська|мови|озвучка|субтитри|локалізація)\b":
    "Інформацію про підтримувані мови буде опубліковано пізніше.",

    # ============ Соціальні мережі ============
    r"\b(де|які|дайте).*(слідкувати|дивитись|офіційні|ресурси|соцмережі|канали|новини|інформація|силку|сайт|форум|обговорення|посилання|ком'юніті)\b":
    "Офіційні ресурси:\nTelegram: [https://t.me/tridentmobile]\nDiscord: [https://discord.gg/mqMgt3XFUw]\nYouTube: [https://youtube.com/@trident.mobile?si=shL9OlJzMSatGg40]\nTiktok: [https://www.tiktok.com/@tridentmobile]\nInstagram: [https://www.instagram.com/trident.mobile]",
    r"\b(чи).*(активні|часто|регулярні|оновлення|новини|щоденні|багато).*(соцмережі|публікують|пости|контенту)\b":
    "Нові матеріали виходять при досягненні необхідної кількості реакцій від спільноти.",

    # ============ Фінанси ============
    r"\b(чи є|хто|як|скільки|чи буде|чи приймаються).*(інвестори|фінансує| бюджет|коштує|краудфандинг|донати|підтримати|допомогти|пресейл)\b":
    "Інформація про фінансування не розголошується.",

    # ============ Інше ============
    r"\b(що|про що|яка|в чому|чим|які).*(проєкт|гра|концепція|ідея|суть|особливого|унікального|відрізняється|нового|фішки|фічі)\b":
    "Детальна інформація про концепцію гри розкрита в публікаціях.",
    r"\b(як|яка|чи буде|чи фінальна).*(називається|назва|зміна назви|правильно називається)\b":
    "Офіційна назва проекту Trident mobile. Зміна назви не планується.",
    r"\b(що|як).*(робити|допомогти|сприяти|прискорити|внести внесок|корисною|підтримати)\b":
    "Найкраща підтримка зараз - це активність у соцмережах (лайки, репости, коментарі).",
}
# Імена, на які бот реагує
BOT_NAMES = ["іван", "іванко", "іванчик", "іван розумник", "ivan", "ivanko"]


# --- Команди ---
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "Привіт! Я чат-бот Trident Mobile. Задайте мені питання про гру!\n"
        "Наприклад: 'Коли реліз?', 'Де скачати гру?', 'Які офіційні посилання?'"
    )


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Список доступних команд:\n"
                                    "/start - Почати роботу\n"
                                    "/help - Допомога\n\n"
                                    "Можна запитати про:\n"
                                    "- Реліз і розробку\n"
                                    "- Спойлери\n"
                                    "- Деталі проєкту\n"
                                    "- Офіційні посилання")


# --- Обробка повідомлень ---
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.lower().strip()

    # Перевіряємо всі питання
    for question_pattern, answer in QA_PAIRS.items():
        if re.search(question_pattern, text, re.IGNORECASE):
            await update.message.reply_text(answer)
            return


# --- Помилки ---
async def error(update: Update, context: ContextTypes.DEFAULT_TYPE):
    print(f"Update {update} caused error {context.error}")


# --- Запуск ---
if __name__ == "__main__":
    print("Starting Trident Mobile bot...")
    app = Application.builder().token(BOT_TOKEN).build()

    # Команди
    app.add_handler(CommandHandler("start", start_command))
    app.add_handler(CommandHandler("help", help_command))

    # Повідомлення
    app.add_handler(MessageHandler(filters.TEXT, handle_message))

    # Помилки
    app.add_error_handler(error)

    print("Polling...")
    app.run_polling(poll_interval=3)
